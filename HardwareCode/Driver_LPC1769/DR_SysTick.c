/*******************************************************************************************************************************//**
 *
 * @file		DR_SysTick.c
 * @brief		Descripcion del modulo
 * @date		4 de may. de 2016
 * @author		Ing. Marcelo Trujillo
 *
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/
#include "DR_SysTick.h"
#include "DR_7seg.h"
#include "DR_Teclado.h"
#include "PR_Timer.h"
#include "DR_DigSig.h"
#include "DR_Sensores.h"

/***********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
 **********************************************************************************************************************************/
#define		TEMP_5SEG		2000
#define		TEMP_6SEG		2400
/***********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
 **********************************************************************************************************************************/
uint32_t Counter_delayms = 0;
uint32_t Counter_delays = 0;
uint32_t i = 0;
extern uint8_t Flag_d ;
/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** PROTOTIPO DE FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES GLOBALES AL MODULO
 **********************************************************************************************************************************/
/** @fn void SysTickInic ( void )
 * @details Inicializacion del systick
 * @details No Portable
 * @param 	void
 * @return 	void.
 */
void SysTick_Inicializacion ( void )
{
	STRELOAD = ( STCALIB / 4) - 1;
	STCURR = 0;

	CLKSOURCE = 1;
	ENABLE = 1;
	TICKINT = 1;
}

void SysTick_Handler(void)
{
	static int j;
	Counter_delayms++;
	Counter_delays++;
	i++;

	if (i == SEGUNDO)
	{
		i=0;

	    tiempo--;
	    timer_timeout--;
	    j++;
	    if (!Flag_memoria)
	    	PedirFecha ();
	    if (j == 10)
	    {

		   // PedirFecha ();
	    	j = 0;
	    }
	    if (!timer_timeout)
	    	Flag_timeout = 1;
	    if(!tiempo)
	    	Flag_T = 1;
	}
	espera_parametros--;
	if(!espera_parametros)
		Flag_Espera = 1;


	DriverTecladoSW ( );
	TimerCheck( );
}
